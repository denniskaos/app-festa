<!-- views/def_rodizio.ejs -->
<div class="toolbar">
  <h1><%= title || 'Rodízio' %></h1>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn btn-light" href="/definicoes">Voltar às definições</a>
    <a class="btn" href="/casais/rodizio">Distribuição por blocos</a>
  </div>
</div>

<% if (err) { %>
  <div class="alert alert-error"><%= err %></div>
<% } %>
<% if (msg) { %>
  <div class="alert alert-success"><%= msg %></div>
<% } %>

<!-- ================== Cartões de resumo ================== -->
<%
  const c = cards || {};
  const euro = (v) => euros ? euros(v) : ((v||0)/100).toFixed(2);
%>
<div class="cards" style="margin-bottom:12px">
  <div class="card stat">
    <div class="stat-label">Saldo movimentos</div>
    <div class="stat-number">€ <%= euro(c.saldoMovimentos) %></div>
    <div class="muted">receitas − despesas + peditórios + patrocínios</div>
  </div>

  <div class="card stat">
    <div class="stat-label">Lucro projetado (jantares pendentes)</div>
    <div class="stat-number">€ <%= euro(c.lucroProjetado) %></div>
    <div class="muted">apenas jantares com lancado = 0</div>
  </div>

  <div class="card stat">
    <div class="stat-label">Saldo projetado</div>
    <div class="stat-number">€ <%= euro(c.saldoProjetado) %></div>
  </div>

  <div class="card stat">
    <div class="stat-label">Total em casais</div>
    <div class="stat-number">€ <%= euro(c.totalCasa) %></div>
  </div>

  <div class="card stat">
    <div class="stat-label">Resto teórico</div>
    <div class="stat-number">€ <%= euro(c.restoTeorico) %></div>
    <div class="muted">saldo projetado − total em casais</div>
  </div>

  <div class="card stat">
    <div class="stat-label">Aplicado do resto</div>
    <div class="stat-number">€ <%= euro(c.aplicadoRestoCents) %></div>
  </div>

  <div class="card stat" style="border-left:4px solid var(--primary,#1f6feb)">
    <div class="stat-label">Resto disponível</div>
    <div class="stat-number">€ <%= euro(c.restoDisponivelCents) %></div>
    <div class="muted">apenas com base nos movimentos (sem projetado)</div>
  </div>
</div>

<!-- ================== Aplicar parte do resto ================== -->
<div class="card" style="margin-bottom:12px">
  <h3>Aplicar parte do resto a um casal</h3>
  <form method="post" action="/definicoes/rodizio/aplicar" class="form-grid" style="grid-template-columns: 1fr 180px 140px">
    <label>
      Casal
      <select name="casal_id" required>
        <option value="">— escolher —</option>
        <% (casais||[]).forEach(function(cs){ %>
          <option value="<%= cs.id %>"><%= cs.nome %> (atual: € <%= euro(cs.valor_casa_cents || 0) %>)</option>
        <% }) %>
      </select>
    </label>
    <label>
      Valor (€)
      <input name="valor" type="number" step="0.01" min="0" inputmode="decimal" required>
    </label>
    <div style="display:flex;align-items:flex-end;gap:8px">
      <button class="btn btn-primary">Aplicar</button>
      <span class="muted">Não pode exceder o <b>Resto disponível</b>.</span>
    </div>
  </form>
</div>

<!-- ================== Parâmetros do rodízio ================== -->
<%
  const blocoCents = Number(settings?.rodizio_bloco_cents ?? 500000);
  const blocoEuros = (blocoCents/100).toFixed(2);
  const inicioId = settings?.rodizio_inicio_casal_id || null;
%>
<div class="card" style="margin-bottom:12px">
  <h3>Parâmetros do rodízio</h3>
  <form method="post" action="/definicoes/rodizio" class="form-grid" style="grid-template-columns: 180px 1fr 140px">
    <label>
      Tamanho do bloco (€)
      <input type="number" name="bloco" step="0.01" min="0" value="<%= blocoEuros %>" inputmode="decimal" />
    </label>

    <label>
      Começar em (casal)
      <select name="inicio_casal_id">
        <option value="">— primeiro da lista —</option>
        <% (casais||[]).forEach(function(cs){ %>
          <option value="<%= cs.id %>" <%= (inicioId && Number(inicioId)===Number(cs.id)) ? 'selected' : '' %>>
            <%= cs.nome %>
          </option>
        <% }) %>
      </select>
    </label>

    <div style="display:flex;align-items:flex-end">
      <button class="btn">Guardar</button>
    </div>
  </form>
</div>

<!-- ================== Histórico de aplicações do resto ================== -->
<div class="card">
  <h3>Histórico de aplicações do resto</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Casal</th>
        <th style="text-align:right">Valor</th>
      </tr>
    </thead>
    <tbody>
      <% if (!historico || !historico.length) { %>
        <tr><td colspan="3" class="muted">Ainda não existem aplicações registadas.</td></tr>
      <% } else { %>
        <% historico.forEach(h => { %>
          <tr>
            <td><%= h.dt || '—' %></td>
            <td><%= h.casal_nome || '—' %></td>
            <td style="text-align:right">€ <%= euro(h.valor_cents) %></td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>
</div>
