<div class="toolbar">
  <h1>Rodízio — Definições</h1>
  <a class="btn btn-light" style="margin-left:auto" href="/definicoes">Voltar</a>
</div>

<% if (err) { %>
  <div class="alert" style="background:#fee;border:1px solid #fbb;color:#900"><%= err %></div>
<% } %>
<% if (msg) { %>
  <div class="alert" style="background:#efe;border:1px solid #bfb;color:#060"><%= msg %></div>
<% } %>

<div class="cards" style="margin-bottom:12px">
  <div class="card stat">
    <div class="stat-label">Saldo movimentos</div>
    <div class="stat-number">€ <%= euros(cards.saldoMovimentos) %></div>
    <div class="muted">receitas − despesas + peditórios + patrocínios</div>
  </div>
  <div class="card stat">
    <div class="stat-label">Lucro projetado (jantares pendentes)</div>
    <div class="stat-number">€ <%= euros(cards.lucroProjetado) %></div>
    <div class="muted">receita = total pago em convidados</div>
  </div>
  <div class="card stat">
    <div class="stat-label">Saldo projetado</div>
    <div class="stat-number">€ <%= euros(cards.saldoProjetado) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Total “em casais”</div>
    <div class="stat-number">€ <%= euros(cards.totalCasa) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Resto teórico</div>
    <div class="stat-number">€ <%= euros(cards.restoTeorico) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Resto disponível</div>
    <div class="stat-number">€ <%= euros(cards.restoDisponivel) %></div>
  </div>
</div>

<div class="card" style="margin-bottom:12px">
  <h3 style="margin-top:0">Parâmetros do rodízio</h3>
  <form method="post" action="/definicoes/rodizio" class="form-grid" style="grid-template-columns: 1fr 1fr auto">
    <label>Valor por bloco (€)
      <input type="number" step="0.01" min="0" name="bloco"
             value="<%= (resumo.blocoCents/100).toFixed(2) %>">
    </label>
    <label>Início do rodízio
      <select name="inicio_casal_id">
        <option value="">(primeiro da lista)</option>
        <% (casais||[]).forEach(c => { %>
          <option value="<%= c.id %>" <%= (settings.rodizio_inicio_casal_id && settings.rodizio_inicio_casal_id===c.id) ? 'selected' : '' %>>
            <%= c.nome %>
          </option>
        <% }) %>
      </select>
    </label>
    <div style="align-self:end">
      <button class="btn btn-primary">Guardar</button>
    </div>
  </form>
</div>

<div class="card" style="margin-bottom:12px">
  <h3 style="margin-top:0">Aplicar parte do resto a um casal</h3>
  <form method="post" action="/definicoes/rodizio/aplicar" class="form-grid" style="grid-template-columns: 2fr 1fr auto">
    <label>Casal
      <select name="casal_id" required>
        <option value="">— escolher —</option>
        <% (casais||[]).forEach(c => { %>
          <option value="<%= c.id %>"><%= c.nome %></option>
        <% }) %>
      </select>
    </label>
    <label>Valor (€)
      <input type="number" step="0.01" min="0" name="valor"
             placeholder="<%= (cards.restoDisponivel/100).toFixed(2) %>">
    </label>
    <div style="align-self:end">
      <button class="btn btn-primary" <%= cards.restoDisponivel<=0 ? 'disabled' : '' %>>
        Aplicar
      </button>
    </div>
  </form>
  <div class="muted" style="margin-top:8px">
    Disponível para aplicar agora: <b>€ <%= euros(cards.restoDisponivel) %></b>
    <% if (cards.restoDisponivel<=0) { %> — (sem saldo disponível neste momento)<% } %>
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0">Histórico de aplicações</h3>
  <table class="table">
    <thead>
      <tr><th>Data</th><th>Casal</th><th style="text-align:right">Valor (€)</th></tr>
    </thead>
    <tbody>
      <% if (!historico || !historico.length) { %>
        <tr><td colspan="3" class="muted">Sem registos.</td></tr>
      <% } else { %>
        <% historico.forEach(h => { %>
          <tr>
            <td><%= h.dt || '—' %></td>
            <td><%= h.casal_nome %></td>
            <td style="text-align:right">€ <%= euros(h.valor_cents) %></td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>
</div>
