<!-- views/def_rodizio.ejs -->
<div class="toolbar">
  <h1>Rodízio</h1>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn" href="/definicoes">← Voltar</a>
  </div>
</div>

<div class="cards" style="margin-bottom:12px;">
  <div class="card stat">
    <div class="stat-label">Total “Em casa”</div>
    <div class="stat-number">€ <%= euros(resumo.totalCasaCents) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Tamanho do bloco</div>
    <div class="stat-number">€ <%= euros(resumo.blocoCents) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Blocos completos</div>
    <div class="stat-number"><%= resumo.blocosCompletos %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Resto teórico</div>
    <div class="stat-number">€ <%= euros(resumo.restoTeoricoCents) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Resto já aplicado</div>
    <div class="stat-number">€ <%= euros(resumo.aplicadoRestoCents) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label"><strong>Resto disponível</strong></div>
    <div class="stat-number"><strong>€ <%= euros(resumo.restoDisponivelCents) %></strong></div>
  </div>
</div>

<% if (err) { %>
  <div class="alert"><%= err %></div>
<% } %>
<% if (msg) { %>
  <div class="alert success"><%= msg %></div>
<% } %>

<div class="card" style="margin-bottom:12px;">
  <h3>Definições do rodízio</h3>
  <form method="post" action="/definicoes/rodizio" class="form-grid">
    <label>Bloco (€)
      <input name="bloco" inputmode="decimal" value="<%= (resumo.blocoCents/100).toFixed(2) %>">
    </label>
    <label>Início (casal)
      <select name="inicio_casal_id">
        <option value="">(sem início fixo)</option>
        <% casais.forEach(c => { %>
          <option value="<%= c.id %>" <%= (String(c.id)===String((settings.rodizio_inicio_casal_id||''))) ? 'selected' : '' %>><%= c.nome %></option>
        <% }) %>
      </select>
    </label>
    <button class="btn">Guardar</button>
  </form>
</div>

<div class="card" style="margin-bottom:12px;">
  <h3>Aplicar resto a um casal</h3>
  <form method="post" action="/definicoes/rodizio/aplicar" class="form-grid">
    <label>Casal
      <select name="casal_id" required>
        <option value="">(escolher casal)</option>
        <% casais.forEach(c => { %>
          <option value="<%= c.id %>"><%= c.nome %></option>
        <% }) %>
      </select>
    </label>
    <label>Valor (€)
      <!-- **IMPORTANTE**: usar placeholder em vez de value -->
      <input name="valor" inputmode="decimal"
             placeholder="<%= (resumo.restoDisponivelCents/100).toFixed(2) %>"
             value="">
    </label>
    <button class="btn btn-primary">Aplicar</button>
  </form>
  <p class="muted" style="margin-top:8px">
    Dica: podes aplicar <em>qualquer</em> parte do resto (ex.: 155,00 €). O restante fica disponível para futuras aplicações.
  </p>
</div>

<div class="card">
  <h3>Histórico de aplicações do resto</h3>
  <table class="table">
    <thead>
      <tr><th>Data</th><th>Casal</th><th>Valor</th></tr>
    </thead>
    <tbody>
      <% if (!historico.length) { %>
        <tr><td colspan="3" class="muted">Ainda sem aplicações.</td></tr>
      <% } %>
      <% historico.forEach(r => { %>
        <tr>
          <td><%= r.dt %></td>
          <td><%= r.casal_nome %></td>
          <td>€ <%= euros(r.valor_cents) %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
