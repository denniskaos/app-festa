<div class="toolbar">
  <h1>Rodízio</h1>
  <a class="btn btn-light" style="margin-left:auto" href="/definicoes">Voltar</a>
</div>

<% if (err) { %>
  <div class="alert"><%= err %></div>
<% } %>
<% if (msg) { %>
  <div class="alert success"><%= msg %></div>
<% } %>

<!-- ====== Cards: totais ====== -->
<div class="cards" style="margin-bottom:12px">
  <div class="card stat">
    <div class="stat-label">Saldo movimentos</div>
    <div class="stat-number">€ <%= euros(resumo.saldoMovimentos) %></div>
    <div class="muted">receitas − despesas + peditórios + patrocínios</div>
  </div>
  <div class="card stat">
    <div class="stat-label">Lucro projetado (jantares pendentes)</div>
    <div class="stat-number">€ <%= euros(resumo.lucroProjetado) %></div>
    <div class="muted">apenas jantares com <code>lancado = 0</code></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Saldo projetado</div>
    <div class="stat-number">€ <%= euros(resumo.saldoProjetado) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Total em casais</div>
    <div class="stat-number">€ <%= euros(resumo.totalCasaCents) %></div>
  </div>
</div>

<div class="cards" style="margin-bottom:16px">
  <div class="card stat">
    <div class="stat-label">Resto teórico</div>
    <div class="stat-number">€ <%= euros(resumo.restoTeorico) %></div>
    <div class="muted">não aplicável ainda (inclui projetado)</div>
  </div>
  <div class="card stat">
    <div class="stat-label">Já aplicado do resto</div>
    <div class="stat-number">€ <%= euros(resumo.aplicadoResto) %></div>
  </div>
  <div class="card stat">
    <div class="stat-label">Resto disponível</div>
    <div class="stat-number">€ <%= euros(resumo.restoDisponivel) %></div>
    <div class="muted">disponível para aplicar agora</div>
  </div>
</div>

<!-- ====== Aplicar resto ====== -->
<div class="card" style="margin-bottom:16px">
  <h3 style="margin-top:0">Aplicar resto disponível</h3>
  <div class="muted" style="margin:-6px 0 12px">
    Resto disponível atual: <b>€ <%= euros(resumo.restoDisponivel) %></b>
  </div>

  <form method="post" action="/definicoes/rodizio/aplicar" class="form-grid">
    <label>Casal
      <select name="casal_id" required>
        <option value="">(escolher casal)</option>
        <% casais.forEach(function(c){ %>
          <option value="<%= c.id %>"><%= c.nome %></option>
        <% }) %>
      </select>
    </label>

    <label>Valor (€)
      <!-- aceita cêntimos -->
      <input name="valor" type="number" step="0.01" min="0" inputmode="decimal" required />
    </label>

    <div></div>
    <div>
      <button class="btn btn-success" type="submit">Aplicar</button>
    </div>
  </form>
</div>

<!-- ====== Definições do rodízio ====== -->
<div class="card" style="margin-bottom:16px">
  <h3 style="margin-top:0">Definições do rodízio</h3>
  <form method="post" action="/definicoes/rodizio" class="form-grid">
    <label>Valor por bloco (€)
      <input type="text" name="bloco"
             value="<%= ( (settings.rodizio_bloco_cents||0)/100 ).toFixed(2).replace('.', ',') %>" />
    </label>

    <label>Primeiro casal na rotação
      <select name="inicio_casal_id">
        <option value="">(lista por omissão)</option>
        <% casais.forEach(function(c){ %>
          <option value="<%= c.id %>" <%= (settings.rodizio_inicio_casal_id===c.id ? 'selected' : '') %>><%= c.nome %></option>
        <% }) %>
      </select>
    </label>

    <div></div>
    <div>
      <button class="btn btn-primary">Guardar</button>
    </div>
  </form>
</div>

<!-- ====== Histórico de aplicações (editar/apagar) ====== -->
<div class="card">
  <h3 style="margin-top:0">Histórico de aplicações do resto</h3>

  <% if (!historico.length) { %>
    <div class="muted">Ainda não existem aplicações registadas.</div>
  <% } else { %>
    <table class="table">
      <thead>
        <tr>
          <th style="width:140px">Data</th>
          <th>Casal</th>
          <th style="width:160px">Valor</th>
          <th style="width:220px">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% historico.forEach(function(h){ %>
          <tr>
            <td><%= h.dt %></td>
            <td><%= h.casal_nome %></td>
            <td>€ <%= euros(h.valor_cents) %></td>
            <td>
              <form method="post" action="/definicoes/rodizio/edit/<%= h.id %>" style="display:inline-flex; gap:8px; align-items:center">
                <input name="valor" type="number" step="0.01" min="0"
                       value="<%= (h.valor_cents/100).toFixed(2) %>"
                       style="width:110px" />
                <button class="btn btn-light" type="submit">Atualizar</button>
              </form>

              <form method="post" action="/definicoes/rodizio/delete/<%= h.id %>" style="display:inline">
                <button class="btn btn-danger" onclick="return confirm('Apagar aplicação?')">Apagar</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>
