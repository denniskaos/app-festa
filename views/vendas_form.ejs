<section class="card">
  <h1>Nova Venda</h1>
  <p class="muted">Adiciona linhas e clica em "Guardar venda".</p>
  <table class="table" id="linhas"><thead><tr><th>Produto</th><th>Qtd</th><th>Preço (€)</th><th></th></tr></thead><tbody></tbody></table>
  <button class="btn" onclick="addLinha()">Adicionar linha</button>
  <form method="post" action="/vendas" onsubmit="return submitVenda()">
    <input type="hidden" name="itens" id="itens" />
    <button class="btn">Guardar venda</button>
  </form>
</section>
<script>
  const produtos = <%- JSON.stringify(produtos) %>;
  function addLinha() {
    const tbody = document.querySelector('#linhas tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td><select class="p"><option value="">--</option>\${produtos.map(p => \`<option value="\${p.id}" data-price="\${(p.price_cents/100).toFixed(2)}">\${p.name}</option>\`).join('')}</select></td>
      <td><input type="number" class="q" value="1" min="1" /></td>
      <td><input type="number" step="0.01" class="pr" /></td>
      <td><button type="button" class="btn btn-danger" onclick="this.closest('tr').remove()">Remover</button></td>
    \`;
    tbody.appendChild(tr);
    const sel = tr.querySelector('.p'); const pr = tr.querySelector('.pr');
    sel.addEventListener('change', e => { pr.value = e.target.selectedOptions[0].dataset.price || ''; });
  }
  function submitVenda() {
    const linhas = [...document.querySelectorAll('#linhas tbody tr')].map(tr => ({
      product_id: +tr.querySelector('.p').value,
      qty: +tr.querySelector('.q').value,
      price: +tr.querySelector('.pr').value
    })).filter(x => x.product_id && x.qty>0 && x.price>=0);
    if (!linhas.length) { alert('Adiciona pelo menos um item.'); return false; }
    document.getElementById('itens').value = JSON.stringify(linhas);
    return true;
  }
</script>