<!-- views/jantares_convidados.ejs -->
<div class="toolbar">
  <h1>Convidados — <%= j.title || j.dt || ('Jantar #' + j.id) %></h1>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn" href="<%= urls.mesas %>">Mesas</a>
    <a class="btn" href="<%= urls.despesas %>">Despesas</a>
    <a class="btn btn-light" href="<%= urls.base %>">Voltar</a>
  </div>
</div>

<!-- Total pago registado -->
<div class="cards" style="margin-bottom:12px;">
  <div class="card stat">
    <div class="stat-label">Total pago (registado)</div>
    <div class="stat-number">€ <%= euros(sumPago) %></div>
  </div>
</div>

<!-- Adicionar convidado -->
<div class="card" style="margin-bottom:16px;">
  <form method="post" action="/jantares/<%= j.id %>/convidados" class="form-grid">
    <label>Nome
      <input name="nome" required />
    </label>

    <label>Mesa
      <select name="mesa_id">
        <option value="">(sem mesa)</option>
        <% (mesas || []).forEach(m => { %>
          <option value="<%= m.id %>"><%= m.nome %></option>
        <% }) %>
      </select>
    </label>

    <label>Menu
      <select name="menu">
        <option value="normal"><%= MENU_LABEL.normal %></option>
        <option value="vegetariano"><%= MENU_LABEL.vegetariano %></option>
        <option value="sem_gluten"><%= MENU_LABEL.sem_gluten %></option>
        <option value="infantil"><%= MENU_LABEL.infantil %></option>
        <option value="outro"><%= MENU_LABEL.outro %></option>
      </select>
    </label>

    <label>Pedido especial
      <input name="pedido_especial" placeholder="ex.: sem sal, alergia a frutos secos" />
    </label>

    <label>Pago (€)
      <input name="pago" type="number" step="0.01" inputmode="decimal" />
    </label>

    <label>Preço (€) <span class="muted">(opcional)</span>
      <input name="preco" type="number" step="0.01" inputmode="decimal"
             placeholder="em branco = usa preço base do jantar" />
    </label>

    <div style="grid-column:1/-1;display:flex;justify-content:flex-start;gap:8px;margin-top:8px">
      <button class="btn btn-primary">Adicionar convidado</button>
    </div>
  </form>
</div>

<!-- Lista de convidados -->
<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Mesa</th>
        <th>Menu</th>
        <th>Pedido especial</th>
        <th>Pago (€)</th>
        <th>Presença</th>
        <th style="width:140px">Ações</th>
      </tr>
    </thead>
    <tbody>
      <% if (!(convidados && convidados.length)) { %>
        <tr><td colspan="7" class="muted">Ainda não existem convidados.</td></tr>
      <% } %>

      <% (convidados || []).forEach(c => { %>
        <tr>
          <td><%= c.nome %></td>
          <td><%= c.mesa_nome || '—' %></td>
          <td><%= MENU_LABEL[c.menu] || c.menu || '—' %></td>
          <td><%= c.pedido_especial || '—' %></td>
          <td>€ <%= euros(c.pago_cents || 0) %></td>
          <td><%= c.presenca ? '✓' : '—' %></td>
          <td>
            <a href="#c<%= c.id %>" class="btn btn-light"
               onclick="document.getElementById('c<%= c.id %>').open=true">Editar</a>
            <form method="post" action="/jantares/<%= j.id %>/convidados/<%= c.id %>/delete"
                  style="display:inline" onsubmit="return confirm('Apagar convidado?')">
              <button class="btn btn-danger">Apagar</button>
            </form>
          </td>
        </tr>

        <!-- Editor colapsável por convidado -->
        <tr>
          <td colspan="7" style="padding:0;border:0">
            <details id="c<%= c.id %>" style="margin:0;padding:0;">
              <summary class="muted" style="padding:10px 12px;cursor:pointer">
                Editar “<%= c.nome %>”
              </summary>
              <div style="padding:12px;border-top:1px solid var(--border,#e5e7eb);background:#fafafa">
                <form method="post" action="/jantares/<%= j.id %>/convidados/<%= c.id %>" class="form-grid">
                  <label>Mesa
                    <select name="mesa_id">
                      <option value="">(sem mesa)</option>
                      <% (mesas || []).forEach(m => { %>
                        <option value="<%= m.id %>" <%= c.mesa_id===m.id ? 'selected' : '' %>><%= m.nome %></option>
                      <% }) %>
                    </select>
                  </label>

                  <label>Nome
                    <input name="nome" value="<%- c.nome %>" />
                  </label>

                  <label>Contacto
                    <input name="contacto" value="<%- c.contacto || '' %>" />
                  </label>

                  <label>Menu
                    <select name="menu">
                      <option value="normal"      <%= c.menu==='normal' ? 'selected':'' %>><%= MENU_LABEL.normal %></option>
                      <option value="vegetariano" <%= c.menu==='vegetariano' ? 'selected':'' %>><%= MENU_LABEL.vegetariano %></option>
                      <option value="sem_gluten"  <%= c.menu==='sem_gluten' ? 'selected':'' %>><%= MENU_LABEL.sem_gluten %></option>
                      <option value="infantil"    <%= c.menu==='infantil' ? 'selected':'' %>><%= MENU_LABEL.infantil %></option>
                      <option value="outro"       <%= c.menu==='outro' ? 'selected':'' %>><%= MENU_LABEL.outro %></option>
                    </select>
                  </label>

                  <label>Pedido especial
                    <input name="pedido_especial" value="<%- c.pedido_especial || '' %>" />
                  </label>

                  <label>Pago (€)
                    <input name="pago" type="number" step="0.01" inputmode="decimal"
                           value="<%= ((c.pago_cents||0)/100).toFixed(2) %>" />
                  </label>

                  <label>Preço (€) <span class="muted">(opcional)</span>
                    <input name="preco" type="number" step="0.01" inputmode="decimal"
                           placeholder="em branco = usa preço base do jantar"
                           value="<%= c.preco_cents!=null ? (c.preco_cents/100).toFixed(2) : '' %>" />
                  </label>

                  <label class="check-row" style="display:flex;gap:8px;align-items:center">
                    <input type="checkbox" name="presenca" value="1" <%= c.presenca ? 'checked' : '' %> />
                    <span>Presente</span>
                  </label>

                  <div style="grid-column:1/-1;display:flex;gap:8px">
                    <button class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-light"
                            onclick="document.getElementById('c<%= c.id %>').open=false">Fechar</button>
                  </div>
                </form>
              </div>
            </details>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
